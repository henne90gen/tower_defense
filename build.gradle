description = """
Tower Defense game, written in python
"""

def executeCommand(String command) {
    def proc = command.execute()
    proc.consumeProcessOutput(System.out, System.err)
    proc.waitForOrKill(120000)
    if (proc.exitValue()) {
        throw new TaskExecutionException( it,
            new Exception( "Command '$command' failed; "
                          + "see task output for details." )
        )
    }
}

task requirements(type: Exec) {
    executable 'pip'
    args = ['install', '-r', 'requirements.txt']
}

task buildSetup() {
    new File('./bin').mkdirs()
    new File('./bin/build').mkdirs()
    new File('./bin/dist').mkdirs()
}

task build(dependsOn: ['requirements', 'buildSetup']) {
    doLast {
        def command = 'pyinstaller --onefile --specpath bin --distpath bin/dist --workpath bin/build tower_defense/main.py'
        executeCommand command
    }
}

task clean() {
    doLast {
        new File('./bin').deleteDir()
        println 'Deleted bin'
    }
}

task test(dependsOn: 'requirements') {
    doLast {
        def command = 'python run_tests.py'
        executeCommand command
    }
}

task coverage(dependsOn: 'requirements') {
    doLast {
        def command = 'coverage run run_tests.py'
        executeCommand command
    }
}
